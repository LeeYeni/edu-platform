package com.example.education.controller;

import com.example.education.dto.GptResponseDto;
import com.example.education.dto.QuizLogRequest;
import com.example.education.service.GptService;
import com.example.education.service.QuestionService;
import com.example.education.util.AihubJsonLoader;
import lombok.RequiredArgsConstructor;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/api/quiz")
@RequiredArgsConstructor
public class GptController {

    private final GptService gptService;
    private final QuestionService questionService;
    private final AihubJsonLoader jsonLoader;

    private static final String PROMPT_PREFIX =
            "아래의 대단원, 중단원, 소단원에 해당하는 초등학교 수학 문제를 생성해줘.\n" +
                    "※ 참고: 대한민국 초등학교 3-4학년 수학 성취기준 전체\n" +

                    "<성취기준 전문>\n" +
                    "Ⅰ. 수와 연산\n" +
                    "Ⅰ. 다섯 자리 이상의 수\n" +
                    "[4수01-01] 큰 수의 필요성을 인식하면서 10000 이상의 큰 수에 대한 자릿값과 위치적 기수법을 이해하고, 수를 읽고 쓸 수 있다.\n" +
                    "[4수01-02] 다섯 자리 이상의 수의 범위에서 수의 계열을 이해하고, 수의 크기를 비교하며 그 방법을 설명할 수 있다.\n" +
                    "\n" +
                    "Ⅱ. 세 자리 수의 덧셈과 뺄셈\n" +
                    "[4수01-03] 세 자리 수의 덧셈과 뺄셈의 계산 원리를 이해하고 그 계산을 할 수 있다.\n" +
                    "\n" +
                    "Ⅲ. 세 자리 수 범위의 곱셈\n" +
                    "[4수01-04] 곱하는 수가 한 자리 수 또는 두 자리 수인 곱셈의 계산 원리를 이해하고 그 계산을 할 수 있다.\n" +
                    "\n" +
                    "Ⅳ. 세 자리 수 범위의 나눗셈\n" +
                    "[4수01-05] 나눗셈이 이루어지는 실생활 상황과 연결하여 나눗셈의 의미를 알고, 곱셈과 나눗셈의 관계를 이해한다.\n" +
                    "[4수01-06] 나누는 수가 한 자리 수인 나눗셈의 계산 원리를 이해하고 그 계산을 할 수 있으며, 나눗셈에서 몫과 나머지의 의미를 안다.\n" +
                    "[4수01-07] 나누는 수가 두 자리 수인 나눗셈의 계산 원리를 이해하고 그 계산을 할 수 있다.\n" +
                    "\n" +
                    "Ⅴ. 자연수의 어림셈\n" +
                    "[4수01-08] 자연수의 덧셈, 뺄셈, 곱셈, 나눗셈과 관련한 여러 가지 상황에서 어림셈을 할 수 있다.\n" +
                    "\n" +
                    "Ⅵ. 분수\n" +
                    "[4수01-09] 양의 등분할을 통하여 분수의 필요성을 인식하고, 분수를 이해하고 읽고 쓸 수 있다.\n" +
                    "[4수01-10] 단위분수, 진분수, 가분수, 대분수를 알고, 그 관계를 이해한다.\n" +
                    "[4수01-11] 분모가 같은 분수끼리, 단위분수끼리 크기를 비교하고 그 방법을 설명할 수 있다.\n" +
                    "\n" +
                    "Ⅶ. 소수\n" +
                    "[4수01-12] 분모가 10인 진분수와 연결하여 소수 한 자리 수를 이해하고 읽고 쓸 수 있다.\n" +
                    "[4수01-13] 자릿값의 원리를 바탕으로 소수 두 자리 수와 소수 세 자리 수를 이해하고 읽고 쓸 수 있다.\n" +
                    "[4수01-14] 소수의 크기를 비교하고 그 방법을 설명할 수 있다.\n" +
                    "\n" +
                    "Ⅷ. 분수의 덧셈과 뺄셈\n" +
                    "[4수01-15] 분모가 같은 분수의 덧셈과 뺄셈의 계산 원리를 이해하고 그 계산을 할 수 있다.\n" +
                    "\n" +
                    "Ⅸ. 소수의 덧셈과 뺄셈\n" +
                    "[4수01-16] 소수 두 자리 수의 범위에서 소수의 덧셈과 뺄셈의 계산 원리를 이해하고 그 계산을 할 수 있다.\n" +
                    "\n" +
                    "(가) 성취기준 해설\n" +
                    "[4수01-03] 덧셈은 세 자리 수의 범위에서 다루되, 합이 네 자리 수인 경우도 포함한다.\n" +
                    "[4수01-04] 곱셈은 '(두 자리 수) × (한 자리 수)', '(세 자리 수) × (한 자리 수)', '(두 자리 수) × (두 자리 수)', '(세 자리 수) × (두 자리 수)'를 다룬다.\n" +
                    "[4수01-06] 나눗셈에서 '(두 자리 수) ÷ (한 자리 수)'는 나누어떨어지는 경우와 나누어떨어지지 않는 경우를 포함하여 몫과 나머지를 이해하게 한다.\n" +
                    "[4수01-07] 나누는 수가 두 자리 수인 나눗셈에서는 '(두 자리 수) ÷ (두 자리 수)', '(세 자리 수) ÷ (두 자리 수)'를 다룬다.\n" +
                    "[4수01-09] 1보다 작은 양을 나타내는 경우를 통하여 분수의 필요성이나 그 표현의 편리함을 인식하게 할 수 있다. 양의 등분할을 통하여 분수를 도입할 때 부분과 전체를 파악하게 하고, '분모', '분자'를 사용한다.\n" +
                    "\n" +
                    "(나) 성취기준 적용 시 고려 사항\n" +
                    "'수와 연산' 영역에서는 '나눗셈, 몫, 나머지, 나누어떨어진다, 분수, 분모, 분자, 단위분수, 진분수, 가분수, 대분수, 자연수, 소수, 소수점(.), ÷' 등의 용어와 기호를 다룬다.\n" +
                    "뉴스, 광고 등 여러 가지 매체를 활용해 실생활에서 다섯 자리 이상의 큰 수가 쓰이는 경우를 찾아보고, 큰 수에 대한 필요성을 인식하게 한다.\n" +
                    "곱셈식과 나눗셈식으로 상황을 나타내어 곱셈과 나눗셈의 관계를 이해하게 한다.\n" +
                    "나눗셈 검산은 나눗셈식을 곱셈식으로 단순히 변환하는 것보다 검산의 목적과 필요성을 이해하는 데 초점을 맞춘다.\n" +
                    "자연수의 사칙연산 전 어림셈을 하여 계산 결과가 타당한지 확인하고, 어림셈이 필요한 실생활 문제를 해결하는 활동을 한다.\n" +
                    "실생활 속 소수 활용 사례를 통해 소수의 필요성을 인식하고, 소수 덧셈과 뺄셈은 계산 원리 이해 수준에서 간단히 다룬다.\n" +
                    "계산 기능 숙달이 목적이 아닐 경우 계산기를 사용하게 할 수 있다.\n" +
                    "'수와 연산' 영역에서 문제해결 전략을 지도하고, 설명하는 과정에서 다른 친구의 의견을 존중하고 경청하는 태도를 기르게 한다.\n" +

                    "Ⅱ. 변화와 관계\n" +
                    "\n" +
                    "Ⅰ. 규칙을 수나 식으로 나타내기\n" +
                    "[4수02-01] 다양한 변화 규칙을 찾아 설명하고, 그 규칙을 수나 식으로 나타낼 수 있다.\n" +
                    "[4수02-02] 계산식의 배열에서 규칙을 찾고, 계산 결과를 추측할 수 있다.\n" +
                    "\n" +
                    "Ⅱ. 등호와 동치 관계\n" +
                    "[4수02-03] 등호를 사용하여 크기가 같은 두 양의 관계를 식으로 나타낼 수 있다.\n" +
                    "\n" +
                    "(가) 성취기준 해설\n" +
                    "[4수02-02] 다양한 규칙을 찾을 수 있는 계산식의 배열, 수의 성질을 탐구할 수 있는 계산식의 배열을 다룬다.\n" +
                    "[4수02-03] 등호(=)의 의미를 토대로 구체물, 그림 등을 사용하여 주어진 식이 옳은지 판단하는 활동, 크기가 같은 두 양을 찾는 활동 등을 통해 동치 관계를 이해하게 한다.\n" +
                    "\n" +
                    "(나) 성취기준 적용 시 고려 사항\n" +
                    "규칙을 식으로 나타낼 때는 혼합 계산식이나 일반항을 나타낸 식을 이용해야 하는 복잡한 문제는 다루지 않는다.\n" +
                    "계산식의 배열에서 계산 결과의 규칙을 찾을 때 필요에 따라 계산기를 사용할 수 있다.\n" +
                    "자신이 추측한 규칙을 배열에 적용해 보는 등 다양한 방법으로 규칙이 옳은지 스스로 검토하게 한다.\n" +
                    "동치 관계는 두 자리 수의 범위에서 다룬다.\n" +
                    "등호가 사용된 식이 옳은지 판단할 때 수 감각이나 직관적으로 이해하고 있는 연산의 성질을 이용해 두 양이 서로 같은지 비교하게 한다.\n" +
                    "'변화와 관계' 영역의 문제 상황에 적합한 문제해결 전략을 지도하고, 문제해결 과정을 설명하게 하여 문제해결 역량을 기르게 한다.\n" +
                    "'변화와 관계' 영역에서 문제해결 과정을 설명할 때 다른 친구의 의견을 존중하고 경청하는 태도로 참여하게 한다.\n" +

                    "Ⅲ. 도형과 측정\n" +
                    "\n" +
                    "Ⅰ. 도형의 기초\n" +
                    "[4수03-01] 직선, 선분, 반직선을 이해하고 구별할 수 있다.\n" +
                    "[4수03-02] 각과 직각을 이해하고, 직각과 비교하는 활동을 통하여 예각과 둔각을 구별할 수 있다.\n" +
                    "[4수03-03] 직선의 수직 관계와 평행 관계를 이해한다.\n" +
                    "\n" +
                    "Ⅱ. 평면도형의 이동\n" +
                    "[4수03-04] 구체물이나 평면도형의 밀기, 뒤집기, 돌리기 활동을 통하여 그 변화를 이해한다.\n" +
                    "[4수03-05] 평면에서 점의 이동에 대해 위치와 방향을 이용하여 설명할 수 있다.\n" +
                    "\n" +
                    "Ⅲ. 원의 구성 요소\n" +
                    "[4수03-06] 원의 중심, 반지름, 지름을 이해하고, 그 성질을 안다.\n" +
                    "[4수03-07] 컴퍼스를 이용하여 여러 가지 크기의 원을 그릴 수 있다.\n" +
                    "\n" +
                    "Ⅳ. 여러 가지 삼각형\n" +
                    "[4수03-08] 여러 가지 모양의 삼각형에 대한 분류 활동을 통하여 이등변삼각형, 정삼각형을 이해하고, 그 성질을 탐구하고 설명할 수 있다.\n" +
                    "[4수03-09] 여러 가지 모양의 삼각형에 대한 분류 활동을 통하여 직각삼각형, 예각삼각형, 둔각삼각형을 이해한다.\n" +
                    "\n" +
                    "Ⅴ. 여러 가지 사각형\n" +
                    "[4수03-10] 여러 가지 모양의 사각형에 대한 분류 활동을 통하여 직사각형, 정사각형, 사다리꼴, 평행사변형, 마름모를 이해하고, 그 성질을 탐구하고 설명할 수 있다.\n" +
                    "\n" +
                    "Ⅵ. 다각형\n" +
                    "[4수03-11] 다각형과 정다각형을 이해한다.\n" +
                    "[4수03-12] 주어진 도형을 이용하여 여러 가지 모양을 만들거나 채우고 설명할 수 있다.\n" +
                    "\n" +
                    "Ⅶ. 시각과 시간\n" +
                    "[4수03-13] 1분과 1초의 관계를 이해하고, 초 단위까지 시각을 읽을 수 있다.\n" +
                    "[4수03-14] 실생활 문제 상황과 연결하여 초 단위까지의 시간의 덧셈과 뺄셈을 할 수 있다.\n" +
                    "\n" +
                    "Ⅷ. 길이\n" +
                    "[4수03-15] 길이 단위 1mm와 1km를 알고, 이를 이용하여 길이를 측정하고 어림하며 수학의 유용성을 인식할 수 있다.\n" +
                    "[4수03-16] 1cm와 1mm, 1km와 1m의 관계를 이해하고, 길이를 ‘몇 cm 몇 mm’와 ‘몇 mm’, ‘몇 km 몇 m’와 ‘몇 m’로 다양하게 표현할 수 있다.\n" +
                    "\n" +
                    "Ⅸ. 들이\n" +
                    "[4수03-17] 들이 단위 1L와 1mL를 알고, 이를 이용하여 들이를 측정하고 어림하며 수학의 유용성을 인식할 수 있다.\n" +
                    "[4수03-18] 1L와 1mL의 관계를 이해하고, 들이를 ‘몇 L 몇 mL’와 ‘몇 mL’로 표현할 수 있다.\n" +
                    "[4수03-19] 실생활 문제 상황과 연결하여 들이의 덧셈과 뺄셈을 할 수 있다.\n" +
                    "\n" +
                    "Ⅹ. 무게\n" +
                    "[4수03-20] 실생활에서 무게를 나타낼 때 사용하는 단위 1g과 1kg을 알고, 이를 이용하여 무게를 측정하고 어림하며 수학의 유용성을 인식할 수 있다.\n" +
                    "[4수03-21] 1kg과 1g의 관계를 이해하고, 무게를 ‘몇 kg 몇 g’과 ‘몇 g’으로 표현할 수 있다.\n" +
                    "[4수03-22] 실생활에서 무게를 나타낼 때 사용하는 단위 1t을 알고, 1t과 1kg의 관계를 이해한다.\n" +
                    "[4수03-23] 실생활 문제 상황과 연결하여 무게의 덧셈과 뺄셈을 할 수 있다.\n" +
                    "\n" +
                    "각도\n" +
                    "[4수03-24] 각의 크기의 단위인 1도(°)를 알고, 각도기를 이용하여 각의 크기를 측정하고 어림할 수 있다.\n" +
                    "[4수03-25] 여러 가지 방법으로 삼각형과 사각형의 내각의 크기의 합을 추론하고, 자신의 추론 과정을 설명할 수 있다.\n" +
                    "\n" +
                    "(가) 성취기준 해설\n" +
                    "[4수03-04] 실생활에서 평면도형의 이동을 활용한 사례를 찾아서 이동에 따른 변화를 추론하고 위치나 방향이 어떻게 변화했는지 설명하게 한다.\n" +
                    "[4수03-05] 평면에서 점의 이동은 격자를 따라 위, 아래, 오른쪽, 왼쪽으로 ‘~칸’, ‘~cm’를 이동하는 수준에서 다룬다.\n" +
                    "[4수03-07] 컴퍼스를 사용하여 다양한 크기의 원을 그리는 방법을 원의 성질과 연결하여 이해하게 한다.\n" +
                    "[4수03-11] 도형판, 모양 조각 등의 교구를 이용한 구체적인 조작 활동을 통해 다각형과 정다각형을 이해하게 한다.\n" +
                    "[4수03-12] 다양한 교구와 공학 도구 등을 이용한 활동을 통해 여러 가지 모양을 만들거나 채울 수 있다.\n" +
                    "[4수03-20] 초등학교에서는 무게와 질량의 개념을 엄밀하게 구분하지 않으며, 무게를 비교하고 측정하는 데 g, kg의 단위를 사용하게 한다.\n" +
                    "\n" +
                    "(나) 성취기준 적용 시 고려 사항\n" +
                    "도형과 측정 영역에서는 용어와 기호로 ‘직선, 선분, 반직선, 각, 직각, 예각, 둔각, 수직, 평행, 원의 중심, 반지름, 지름, 삼각형, 사각형, 다각형, 정다각형, 대각선, 초, 도(°), mm, km, L, mL, g, kg, t’를 다룬다.\n" +
                    "직선, 선분, 반직선을 구별할 수 있는지 평가한다.\n" +
                    "평면도형 이동에서는 복잡한 이동(돌리고 뒤집기 등)을 지양한다.\n" +
                    "삼각형, 사각형의 성질은 관찰, 실험, 측정을 통해 이해하도록 한다.\n" +
                    "실제로 재거나 어림하는 활동을 통해 시간, 길이, 들이, 무게, 각도에 대한 양감을 기른다.\n" +
                    "문제 해결 과정에서 다른 친구들의 의견을 존중하고 경청하는 태도를 기른다.\n" +

                    "Ⅳ. 자료와 가능성\n" +
                    "\n" +
                    "Ⅰ. 자료의 수집과 정리\n" +
                    "[4수04-01] 자료를 수집하여 그림그래프나 막대그래프로 나타내고 해석할 수 있다.\n" +
                    "[4수04-02] 자료를 수집하여 꺾은선그래프로 나타내고 해석할 수 있다.\n" +
                    "[4수04-03] 탐구 문제를 해결하기 위해 자료를 수집, 정리하여 막대그래프나 꺾은선그래프로 나타내고 해석할 수 있다.\n" +
                    "\n" +
                    "(가) 성취기준 해설\n" +
                    "[4수04-03] 여러 가지 문제를 해결하기 위해 자료를 수집, 정리하고 그래프로 나타내어 해석하는 일련의 과정을 직접 경험하게 한다. 자료의 크기를 비교할 때는 막대그래프를, 시간에 따른 변화 경향을 알아볼 때는 꺾은선그래프를 사용하는 것이 편리함을 이해하게 한다.\n" +
                    "\n" +
                    "(나) 성취기준 적용 시 고려 사항\n" +
                    "자료와 가능성 영역에서는 용어와 기호로 ‘그림그래프, 막대그래프, 꺾은선그래프’를 다룬다.\n" +
                    "문제 상황에 맞게 간단한 설문조사, 실험, 관찰, 공공 자료 등을 통해 자료를 직접 수집하게 한다.\n" +
                    "그림그래프를 그릴 때는 항목의 이름과 수량 단위를 명확히 인식하고, 자료의 개수에 따라 그림의 단위를 적절히 선택하게 한다.\n" +
                    "막대그래프와 꺾은선그래프를 그릴 때는 가로축과 세로축의 의미를 확인하고, 눈금 한 칸이 나타내는 크기를 적절히 선택한다.\n" +
                    "막대그래프와 꺾은선그래프 작성 시 공학 도구를 사용하게 할 수 있다.\n" +
                    "수집한 자료의 특성과 목적에 따라 적절한 그래프를 선택하는 비판적 사고를 기르게 한다.\n" +
                    "문제 해결 과정에서 다른 친구들의 의견을 존중하고 경청하는 태도를 기른다.\n" +

                    "주의사항:\n" +
                    "- 위 성취기준은 '문제 출제 시 참고용'이야.\n" +
                    "- 문제는 요청된 '대단원/중단원/소단원' 주제에 맞게 생성해야 해.\n" +
                    "- 난이도는 초등학교 3-4학년 학생이 풀 수 있도록 조정해.\n" +
                    "- 문제 지문, 보기, 해설에서는 반드시 초등학교 수준의 표현을 사용해.\n" +

                    "조건:\n" +
                    "1. 문제 개수는 정확히 N개 생성해줘. (아래 [문제 개수]를 참고해)\n" +
                    "2. 문제는 객관식(4지선다), OX, 주관식 중 하나로 생성해줘.\n" +
                    "- 객관식인 경우, options의 id별 text가 모두 달라야만 해.\n" +
                    "- OX인 경우, answer이 false일 땐 explanation에 정답 풀이를 작성하고, text에는 오답을 적어줘.\n" +
                    "3. 문제 유형은 다음 중 하나로 지정해줘: 'multiple', 'truefalse', 'subjective'\n" +
                    "4. **answer는 반드시 정답으로 설정한 보기 또는 값과 정확히 일치해야 해.**\n" +
                    "- 예: 계산 결과가 false인데 answer가 true면 안 돼.\n" +
                    "- 숫자 계산 또는 판단 결과를 기준으로 정확한 논리값(true/false), 보기 ID(a/b/...), 또는 정확한 주관식 텍스트를 넣어야 해.\n" +
                    "중요: 해설(explanation)에는 반드시 정답(answer)을 근거로 설명하고, 오답을 정답으로 착각하게 적지 말 것. 정답과 해설이 불일치하면 오류로 간주합니다.\n" +
                    "\n" +
                    "중요: 해설(explanation)은 명확하고 직관적으로 작성해야 합니다. '799가 아니라 799입니다'처럼 모순되거나 불필요하게 중복된 문장은 금지합니다.\n" +
                    "\n" +
                    "해설 작성 시 다음 3단계 구조를 반드시 따르세요:\n" +
                    "[문제 풀이 → 정답 도출 → 정답 근거 요약]의 3단계로 깔끔하게 설명합니다.\n" +
                    "\n" +
                    "강제 조건:\n" +
                    "- 'answer'로 지정한 보기(option)는 반드시 해설에서 정답으로 설명해야 합니다.\n" +
                    "- 예를 들어 answer가 'a'라면, 해설에는 'a가 정답인 이유'를 써야 하고, 'a는 오답입니다' 같은 문장은 금지합니다.\n" +
                    "- 문제(text), 보기(options), 정답(answer), 해설(explanation)은 하나의 세트로 일관성 있게 작성해야 합니다.\n" +
                    "\n" +
                    "문제를 생성할 때 반드시 다음 흐름을 따르세요:\n" +
                    "① 문제(text) 생성 → ② 보기(options) 생성 → ③ 정답(answer) 선택 → ④ 선택한 정답(answer)의 id를 기반으로 해설(explanation) 작성.\n" +
                    "\n" +
                    "강제 검증:\n" +
                    "- 해설에서 계산하거나 논리적으로 도출한 정답과, answer로 지정한 보기(option)의 text가 정확히 일치해야 합니다.\n" +
                    "- 정답으로 설정한 option이 해설 내용과 다를 경우, 해당 문제는 무효로 간주하고 문제를 다시 출제해야 합니다.\n" +
                    "- 문제를 출제한 후, 반드시 options 목록을 순회하여 해설에서 계산한 결과와 일치하는 option을 찾아 그 option의 id를 answer로 설정해야 합니다.\n" +
                    "- options에 정답이 없는 경우 문제를 폐기하고 새로 출제해야 합니다.\n" +
                    "\n" +
                    "※ 추가 강제 규칙 (객관식 multiple 문제 출제 시):\n" +
                    "\n" +
                    "- 객관식(multiple) 문제에서는 보기 중 정답이 반드시 정확히 하나만 존재해야 한다.\n" +
                    "- 복수 정답(2개 이상) 상황이 발생할 수 있는 문제는 출제하지 않는다.\n" +
                    "- 문제를 출제할 때, 정답 후보를 철저히 검토하여 정답이 오직 하나만 존재하는지 반드시 확인할 것.\n" +
                    "- 정답이 여러 개가 될 수 있는 문제(예: 2개 보기 모두 계산이 맞는 경우)는 출제 자체를 금지한다.\n" +
                    "- '복수 선택형 문제'는 절대 출제하지 않는다. (\"모두 고르세요\" 형태 금지)\n" +
                    "- 문제 지문은 항상 단일 정답(single answer) 상황을 가정하여 작성해야 하며, 복수 정답 가능성이 의심되는 문제는 생성하지 않는다.\n" +
                    "\n" +
                    "※ 요약:\n" +
                    "- 객관식 문제(multiple)는 무조건 정답 하나(single answer)만 허용\n" +
                    "- 복수 정답(multiple answers)은 절대 허용하지 않음\n" +
                    "- 정답(answer)와 해설(explanation)은 반드시 일치해야 하며, options 중 정확히 일치하는 id만 answer로 설정\n" +
                    "- 불일치 발생 시 문제 폐기 및 재출제\n" +
                    "\n" +
                    "※ 요약:\n" +
                    "객관식 문제(multiple)는 무조건 정답 하나(single-answer)만 허용. 복수 정답(multiple-answers)은 절대 허용하지 않음. 정답이 둘 이상일 가능성이 있는 문제는 출제 금지.\n" +
                    "\n" +
                    "문제는 아래 JSON 형식 중 하나로 생성해줘. 그리고 최종 결과는 반드시 배열([])로 출력해줘.\n" +
                    "\n" +
                    "객관식 예시:\n" +
                    "{\n" +
                    "  \"id\": \"q1\",\n" +
                    "  \"type\": \"multiple\",\n" +
                    "  \"text\": \"질문 내용\",\n" +
                    "  \"options\": [\n" +
                    "    { \"id\": \"a\", \"text\": \"보기 1\" },\n" +
                    "    { \"id\": \"b\", \"text\": \"보기 2\" },\n" +
                    "    { \"id\": \"c\", \"text\": \"보기 3\" },\n" +
                    "    { \"id\": \"d\", \"text\": \"보기 4\" }\n" +
                    "  ],\n" +
                    "  \"answer\": \"b\",\n" +
                    "  \"explanation\": \"해설\"\n" +
                    "}\n" +
                    "\n" +
                    "OX 예시:\n" +
                    "{\n" +
                    "  \"id\": \"q2\",\n" +
                    "  \"type\": \"truefalse\",\n" +
                    "  \"answer\": true,\n" +
                    "  \"text\": \"질문 내용\",\n" +
                    "  \"explanation\": \"해설\"\n" +
                    "}\n" +
                    "\n" +
                    "주관식 예시:\n" +
                    "{\n" +
                    "  \"id\": \"q3\",\n" +
                    "  \"type\": \"subjective\",\n" +
                    "  \"text\": \"질문 내용\",\n" +
                    "  \"answer\": \"정답\",\n" +
                    "  \"explanation\": \"해설\"\n" +
                    "}\n" +
                    "\n" +
                    "위 형식에 따라 문제들을 JSON 배열로 묶어서 출력해줘.\n" +
                    "**중요**: 속성명은 반드시 큰따옴표로 감싸고, 최종 결과는 유효한 JSON 배열이어야 해.";




    @PostMapping("/log")
    public GptResponseDto generateFromQuizLog(@RequestBody QuizLogRequest req) {
        try {
            // 1. 학년/단원 → 경로, 파일 prefix 추출
            // String gradeFolder = convertGradeToFolder(req.getGrade());

            // String prompt = jsonLoader.extractPromptText(gradeFolder, "P3_1_01_00040_00474.json");
            String prompt = "[대단원] " + req.getChapter() + ", [중단원] " + req.getMiddle() + ", [소단원] " + req.getSmall() + "[문제 개수] " + req.getNumberOfProblems() + "개";
            String response = gptService.getGptResponse(PROMPT_PREFIX + prompt);

            String questionId = questionService.saveQuestionsFromGptResponse(req.getUserId(), req.getUserType(), req.getChapter(), req.getMiddle(), req.getSmall(), response);

            return new GptResponseDto(prompt, response, questionId);

        } catch (Exception e) {
            return new GptResponseDto("오류 발생", "❌ 응용 문제 생성 실패: " + e.getMessage(), null);
        }
    }
}
